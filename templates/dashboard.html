<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIAS - Predictive Inventory Analyzer System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fadeIn': 'fadeIn 0.5s ease-in-out',
                        'slideIn': 'slideInUp 0.3s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        .status.critical { background-color: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .status.high { background-color: #fef3c7; color: #d97706; padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .status.medium { background-color: #fef9c3; color: #ca8a04; padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .status.low { background-color: #dcfce7; color: #16a34a; padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .status.healthy { background-color: #dcfce7; color: #16a34a; padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        
        .drag-over { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .loading-spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: #fff; animation: spin 1s ease-in-out infinite;
        }
        
        .typing-dots span {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background-color: #9ca3af; animation: bounce 1.4s ease-in-out infinite both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes slideInUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .chart-container { position: relative; min-height: 300px; display: flex; align-items: center; justify-content: center; }
        .chart-container img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Header -->
    <header class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white shadow-2xl border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-r from-green-600 to-green-700 rounded-xl shadow-lg">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
                            PIAS - Predictive Inventory Analyzer System
                        </h1>
                        <p class="text-sm text-gray-400">Professional Edition v2.0</p>
                    </div>
                </div>

                <nav class="flex space-x-1">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-button active">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button onclick="switchTab('ai-assistant')" id="tab-ai-assistant" class="tab-button">
                        <i class="fas fa-robot mr-2"></i>AI Assistant
                    </button>
                    <button onclick="switchTab('reports')" id="tab-reports" class="tab-button">
                        <i class="fas fa-file-alt mr-2"></i>Reports
                    </button>
                </nav>

                <div class="text-right">
                    <div class="text-sm text-gray-400" id="last-updated">System Ready</div>
                    <div class="text-sm text-green-400 flex items-center">
                        <div class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                        <span id="system-status">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="tab-content">
            <div class="space-y-8">
                <!-- Upload Section -->
                <div id="upload-section" class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Your Inventory Data
                        </h2>
                        <p class="text-green-100 text-sm mt-1">Supported formats: CSV files up to 25MB</p>
                    </div>

                    <div class="p-6">
                        <div id="upload-idle" class="upload-state">
                            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-500 hover:bg-green-50 transition-all duration-200 cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-medium text-gray-700 mb-2">Drop your CSV file here or click to browse</p>
                                <p class="text-sm text-gray-500 mb-4">Required columns: Product Name, Category, Stock Quantity, Monthly Sales</p>
                                <div class="flex justify-center space-x-4 text-xs text-gray-400">
                                    <span><i class="fas fa-check text-green-500 mr-1"></i>Automatic column detection</span>
                                    <span><i class="fas fa-check text-green-500 mr-1"></i>Data quality validation</span>
                                    <span><i class="fas fa-check text-green-500 mr-1"></i>Professional analytics</span>
                                </div>
                                <input type="file" id="file-input" accept=".csv" class="hidden">
                            </div>
                        </div>

                        <div id="upload-processing" class="upload-state hidden">
                            <div class="text-center space-y-4">
                                <div class="loading-spinner w-12 h-12 mx-auto border-green-500"></div>
                                <p class="text-lg font-medium">Processing your inventory data...</p>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="progress-bar" class="bg-gradient-to-r from-green-600 to-green-700 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <div class="text-sm text-gray-600" id="processing-status">Analyzing CSV structure...</div>
                            </div>
                        </div>

                        <div id="upload-success" class="upload-state hidden">
                            <div class="text-center space-y-4">
                                <i class="fas fa-check-circle text-5xl text-green-500"></i>
                                <p class="text-lg font-medium text-green-700">Data processed successfully!</p>
                                <p class="text-sm text-gray-600">Professional analysis completed - your dashboard is ready.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Main Content -->
                <div id="dashboard-main" class="hidden space-y-8">
                    <!-- Action Bar -->
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Inventory Dashboard</h2>
                            <p class="text-gray-600" id="dashboard-subtitle">Real-time analytics and insights</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="refreshDashboard()" class="btn-secondary">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                            <button onclick="resetDashboard()" class="btn-primary">
                                <i class="fas fa-upload mr-2"></i>Upload New File
                            </button>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="metric-card bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                                    <i class="fas fa-boxes text-2xl"></i>
                                </div>
                                <i class="fas fa-arrow-up text-blue-300"></i>
                            </div>
                            <h3 class="text-sm font-medium opacity-80 mb-1">Total Products</h3>
                            <p class="text-3xl font-bold" id="total-products">0</p>
                            <div class="text-xs opacity-60 mt-2">Across all categories</div>
                        </div>

                        <div class="metric-card bg-gradient-to-r from-red-500 to-red-600 rounded-2xl shadow-xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                                </div>
                                <i class="fas fa-arrow-down text-red-300"></i>
                            </div>
                            <h3 class="text-sm font-medium opacity-80 mb-1">Critical Alerts</h3>
                            <p class="text-3xl font-bold" id="critical-alerts">0</p>
                            <div class="text-xs opacity-60 mt-2">Items need attention</div>
                        </div>

                        <div class="metric-card bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl shadow-xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                                    <i class="fas fa-sync-alt text-2xl"></i>
                                </div>
                                <i class="fas fa-arrow-up text-purple-300"></i>
                            </div>
                            <h3 class="text-sm font-medium opacity-80 mb-1">Average Turnover</h3>
                            <p class="text-3xl font-bold" id="avg-turnover">0x</p>
                            <div class="text-xs opacity-60 mt-2">Annual rate</div>
                        </div>

                        <div class="metric-card bg-gradient-to-r from-green-500 to-green-600 rounded-2xl shadow-xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                                    <i class="fas fa-heart-pulse text-2xl"></i>
                                </div>
                                <i class="fas fa-arrow-up text-green-300"></i>
                            </div>
                            <h3 class="text-sm font-medium opacity-80 mb-1">Inventory Health</h3>
                            <p class="text-3xl font-bold" id="inventory-health">0%</p>
                            <div class="text-xs opacity-60 mt-2">Overall score</div>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-filter mr-2 text-green-600"></i>Smart Filtering & Search
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
                            <div class="lg:col-span-4 relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Search products..." 
                                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                                <div id="filter-loader" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                                    <div class="loading-spinner w-5 h-5"></div>
                                </div>
                            </div>

                            <div class="lg:col-span-3 relative">
                                <select id="category-filter" class="w-full appearance-none bg-white border border-gray-300 rounded-xl px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                                    <option value="All Categories">All Categories</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>

                            <div class="lg:col-span-5" id="status-filters">
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="setStatusFilter('All')" class="filter-btn active" data-filter="All">
                                        <i class="fas fa-list mr-1"></i>All
                                    </button>
                                    <button onclick="setStatusFilter('CRITICAL')" class="filter-btn" data-filter="CRITICAL">
                                        <i class="fas fa-exclamation-circle mr-1"></i>Critical
                                    </button>
                                    <button onclick="setStatusFilter('LOW')" class="filter-btn" data-filter="LOW">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>Low
                                    </button>
                                    <button onclick="setStatusFilter('HEALTHY')" class="filter-btn" data-filter="HEALTHY">
                                        <i class="fas fa-check-circle mr-1"></i>Healthy
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button onclick="showSlowMovers()" class="action-btn">
                                <i class="fas fa-turtle mr-2"></i>Show Slow Movers
                            </button>
                            <button onclick="showFastMovers()" class="action-btn">
                                <i class="fas fa-rocket mr-2"></i>Show Fast Movers
                            </button>
                            <button onclick="exportReport()" class="action-btn">
                                <i class="fas fa-download mr-2"></i>Export Report
                            </button>
                            <button onclick="generateInsights()" class="action-btn">
                                <i class="fas fa-lightbulb mr-2"></i>Generate Insights
                            </button>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-chart-bar mr-2 text-blue-600"></i>Category Performance
                            </h3>
                            <div class="chart-container">
                                <img id="category-chart" class="hidden" alt="Category Performance Chart">
                                <div id="category-chart-placeholder" class="text-center text-gray-500">
                                    <i class="fas fa-chart-bar text-6xl mb-4 opacity-50"></i>
                                    <p>Chart will appear here after data upload</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-green-600"></i>Inventory Health Distribution
                            </h3>
                            <div class="chart-container">
                                <img id="health-chart" class="hidden" alt="Inventory Health Chart">
                                <div id="health-chart-placeholder" class="text-center text-gray-500">
                                    <i class="fas fa-chart-pie text-6xl mb-4 opacity-50"></i>
                                    <p>Chart will appear here after data upload</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-chart-line mr-2 text-purple-600"></i>Turnover Analysis Dashboard
                            </h3>
                            <div class="chart-container">
                                <img id="turnover-chart" class="hidden" alt="Turnover Analysis Chart">
                                <div id="turnover-chart-placeholder" class="text-center text-gray-500">
                                    <i class="fas fa-chart-line text-6xl mb-4 opacity-50"></i>
                                    <p>Advanced analytics will appear here</p>
                                </div>
                            </div>
                        </div>

                        <!-- Priority Reorder List -->
                        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                            <div class="bg-gradient-to-r from-gray-900 to-gray-800 px-6 py-4">
                                <h3 class="text-lg font-bold text-white flex items-center">
                                    <i class="fas fa-list-ul mr-2"></i>Priority Reorder List
                                </h3>
                                <p class="text-gray-300 text-sm">Items requiring immediate attention</p>
                            </div>

                            <div class="max-h-96 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reorder-table-body" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                                                <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
                                                <p>No reorder data available</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Assistant Tab -->
        <div id="ai-assistant-content" class="tab-content hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-robot mr-2"></i>PIAS AI Assistant
                        </h2>
                        <p class="text-green-100 text-sm">AI-powered inventory insights and recommendations</p>
                    </div>

                    <div id="chat-messages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-gray-50 to-white">
                        <div class="flex justify-start">
                            <div class="bg-white border border-gray-200 px-4 py-3 rounded-2xl shadow-lg max-w-xs lg:max-w-md">
                                <div class="flex items-start space-x-2">
                                    <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-robot text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm">Hi! I'm your PIAS AI assistant. I can help you with:</p>
                                        <div class="mt-3 space-y-2">
                                            <button onclick="setChatMessage('Show me critical items that need restocking')" class="chat-suggestion">
                                                • Critical items analysis
                                            </button>
                                            <button onclick="setChatMessage('Analyze my slow-moving inventory')" class="chat-suggestion">
                                                • Slow-movers optimization
                                            </button>
                                            <button onclick="setChatMessage('How can I improve my inventory turnover?')" class="chat-suggestion">
                                                • Turnover improvement strategies
                                            </button>
                                            <button onclick="setChatMessage('Generate an inventory health report')" class="chat-suggestion">
                                                • Health assessment & recommendations
                                            </button>
                                        </div>
                                        <p class="text-xs opacity-70 mt-2" id="initial-timestamp"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 p-4">
                        <div class="flex gap-2 mb-3 flex-wrap">
                            <button onclick="setChatMessage('Show Restock Priorities')" class="quick-chat-btn">Restock Priorities</button>
                            <button onclick="setChatMessage('Analyze Slow Movers')" class="quick-chat-btn">Slow Movers</button>
                            <button onclick="setChatMessage('Fast Movers Analysis')" class="quick-chat-btn">Fast Movers</button>
                            <button onclick="setChatMessage('Inventory Health Check')" class="quick-chat-btn">Health Check</button>
                            <button onclick="setChatMessage('ABC Classification Analysis')" class="quick-chat-btn">ABC Analysis</button>
                        </div>

                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Ask about your inventory..." 
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            <button onclick="sendChatMessage()" class="chat-send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-content" class="tab-content hidden">
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-8 flex items-center">
                        <i class="fas fa-file-chart-line mr-3 text-green-600"></i>Reports & Analytics
                    </h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Export Options</h3>
                            <div class="space-y-3">
                                <button onclick="exportReport('json')" class="export-btn">
                                    <i class="fas fa-code mr-2"></i>Export JSON Report
                                </button>
                                <button onclick="exportReport('csv')" class="export-btn">
                                    <i class="fas fa-table mr-2"></i>Export CSV Data
                                </button>
                                <button onclick="printDashboard()" class="export-btn">
                                    <i class="fas fa-print mr-2"></i>Print Dashboard
                                </button>
                                <button onclick="generateExecutiveSummary()" class="export-btn">
                                    <i class="fas fa-chart-pie mr-2"></i>Executive Summary
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Report Summary</h3>
                            <div class="bg-gray-50 rounded-xl p-6 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Total Products:</span>
                                    <span class="font-bold text-gray-900" id="report-total-products">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Critical Alerts:</span>
                                    <span class="font-bold text-red-600" id="report-critical-alerts">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Health Score:</span>
                                    <span class="font-bold text-green-600" id="report-inventory-health">0%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Average Turnover:</span>
                                    <span class="font-bold text-blue-600" id="report-avg-turnover">0x</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Generated:</span>
                                    <span class="text-gray-600 text-sm" id="report-generated">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Enhanced API Configuration - Dynamic URL Detection
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000/api' 
            : '/api';
        
        // Global State Management
        let appState = {
            currentSession: null,
            currentDataset: null,
            currentKPIs: { totalProducts: 0, criticalAlerts: 0, averageTurnover: 0, inventoryHealth: 0 },
            currentReorderData: [],
            isLoading: false,
            charts: {},
            filterOptions: {},
            lastUpdated: null
        };

        // Application Initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateTimestamps();
            checkAPIHealth();
        });

        function initializeApp() {
            console.log('🚀 PIAS Dashboard v2.0 - Initializing...');
            document.getElementById('initial-timestamp').textContent = new Date().toLocaleTimeString();
            updateSystemStatus('Online');
        }

        function setupEventListeners() {
            // File upload
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');

            fileInput.addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);

            // Search and filters
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');

            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 300);
            });

            categoryFilter.addEventListener('change', applyFilters);

            // Chat
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        }

        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const result = await response.json();
                
                if (result.status === 'healthy') {
                    updateSystemStatus('Online');
                    console.log('✅ API Health Check Passed');
                } else {
                    updateSystemStatus('Degraded');
                    console.warn('⚠️  API Running with limited functionality');
                }
            } catch (error) {
                updateSystemStatus('Offline');
                console.error('❌ API Health Check Failed:', error);
                showNotification('API connection issues detected', 'error');
            }
        }

        function updateSystemStatus(status) {
            const statusElement = document.getElementById('system-status');
            statusElement.textContent = status;
        }

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'bg-gradient-to-r', 'from-green-600', 'to-green-700', 'text-white', 'shadow-lg');
                button.classList.add('text-gray-300', 'hover:text-white', 'hover:bg-gray-700');
            });

            document.getElementById(tabName + '-content').classList.remove('hidden');

            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.remove('text-gray-300', 'hover:text-white', 'hover:bg-gray-700');
            activeButton.classList.add('active', 'bg-gradient-to-r', 'from-green-600', 'to-green-700', 'text-white', 'shadow-lg');
        }

        // File Upload Functions
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                handleFileUpload(files[0]);
            } else {
                showNotification('Please upload a CSV file only.', 'error');
            }
        }

        async function handleFileUpload(file) {
            if (appState.isLoading) return;
            
            try {
                appState.isLoading = true;
                showUploadState('processing');
                updateProgress(0, 'Initializing upload...');

                const formData = new FormData();
                formData.append('csvFile', file);

                updateProgress(25, 'Uploading file...');

                const response = await fetch(`${API_BASE_URL}/upload-csv`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(75, 'Processing data...');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    updateProgress(100, 'Complete!');
                    
                    appState.currentSession = result.sessionId;
                    appState.currentDataset = result.data;
                    appState.lastUpdated = new Date();
                    
                    await updateDashboard(result.data);
                    
                    showUploadState('success');
                    setTimeout(() => {
                        document.getElementById('upload-section').classList.add('hidden');
                        document.getElementById('dashboard-main').classList.remove('hidden');
                    }, 2000);
                    
                    showNotification('Data processed successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Upload error:', error);
                showNotification(`Upload failed: ${error.message}`, 'error');
                showUploadState('idle');
            } finally {
                appState.isLoading = false;
            }
        }

        function updateProgress(percentage, message) {
            const progressBar = document.getElementById('progress-bar');
            const statusElement = document.getElementById('processing-status');
            
            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (statusElement) statusElement.textContent = message;
        }

        function showUploadState(state) {
            document.querySelectorAll('.upload-state').forEach(el => el.classList.add('hidden'));

            const states = {
                'idle': 'upload-idle',
                'processing': 'upload-processing', 
                'success': 'upload-success'
            };

            const targetState = document.getElementById(states[state]);
            if (targetState) {
                targetState.classList.remove('hidden');
            }
        }

        // Dashboard Update Functions
        async function updateDashboard(data) {
            try {
                console.log('📊 Updating dashboard with data:', data);

                if (data.kpis) {
                    updateKPICards(data.kpis);
                    appState.currentKPIs = data.kpis;
                }

                if (data.charts) {
                    await updateCharts(data.charts);
                    appState.charts = data.charts;
                }

                if (data.reorderData) {
                    updateReorderTable(data.reorderData);
                    appState.currentReorderData = data.reorderData;
                }

                if (data.filterOptions) {
                    updateFilterOptions(data.filterOptions);
                    appState.filterOptions = data.filterOptions;
                }

                if (data.metadata) {
                    document.getElementById('dashboard-subtitle').textContent = 
                        `Processed ${data.metadata.totalRows} products from ${data.metadata.filename}`;
                }

                updateTimestamps();
                console.log('✅ Dashboard updated successfully');
                
            } catch (error) {
                console.error('❌ Dashboard update error:', error);
                showNotification('Dashboard update error', 'error');
            }
        }

        function updateKPICards(kpis) {
            const updates = {
                'total-products': kpis.totalProducts?.toLocaleString() || '0',
                'critical-alerts': kpis.criticalAlerts || '0', 
                'avg-turnover': `${kpis.averageTurnover || 0}x`,
                'inventory-health': `${kpis.inventoryHealth || 0}%`
            };

            Object.entries(updates).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });

            // Update report summary
            document.getElementById('report-total-products').textContent = kpis.totalProducts?.toLocaleString() || '0';
            document.getElementById('report-critical-alerts').textContent = kpis.criticalAlerts || '0';
            document.getElementById('report-inventory-health').textContent = `${kpis.inventoryHealth || 0}%`;
            document.getElementById('report-avg-turnover').textContent = `${kpis.averageTurnover || 0}x`;
        }

        async function updateCharts(charts) {
            const chartMappings = {
                'category-chart': 'categoryPerformance',
                'health-chart': 'inventoryHealth', 
                'turnover-chart': 'turnoverAnalysis'
            };

            for (const [elementId, chartKey] of Object.entries(chartMappings)) {
                const chartImg = document.getElementById(elementId);
                const placeholder = document.getElementById(elementId + '-placeholder');

                if (charts[chartKey]) {
                    try {
                        chartImg.src = charts[chartKey];
                        chartImg.classList.remove('hidden');
                        if (placeholder) placeholder.classList.add('hidden');
                    } catch (error) {
                        console.warn(`Chart error for ${chartKey}:`, error);
                    }
                }
            }
        }

        function updateReorderTable(reorderData) {
            const tableBody = document.getElementById('reorder-table-body');

            if (!reorderData || reorderData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-check-circle text-3xl mb-2 text-green-500"></i>
                            <p>No urgent reorders needed!</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = '';

            reorderData.slice(0, 10).forEach((item) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';

                const productName = item.product || item.name || 'Unknown Product';
                const currentStock = item.currentStock || item.current_stock || 0;
                const status = item.status || item.urgency || 'Unknown';
                const statusClass = status.toLowerCase();

                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-900 text-sm">${productName}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">${currentStock}</td>
                    <td class="px-4 py-3">
                        <span class="status ${statusClass}">${status}</span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateFilterOptions(filterOptions) {
            const categorySelect = document.getElementById('category-filter');

            categorySelect.innerHTML = '<option value="All Categories">All Categories</option>';
            
            if (filterOptions.categories && Array.isArray(filterOptions.categories)) {
                filterOptions.categories.forEach(category => {
                    if (category && category !== 'All Categories') {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    }
                });
            }
        }

        // Filter Functions
        function setStatusFilter(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            applyFilters();
        }

        async function applyFilters() {
            if (!appState.currentSession || appState.isLoading) {
                return;
            }

            const searchTerm = document.getElementById('search-input').value.trim();
            const category = document.getElementById('category-filter').value;
            const statusFilter = document.querySelector('.filter-btn.active')?.getAttribute('data-filter') || 'All';

            const filters = {
                sessionId: appState.currentSession,
                category: category !== "All Categories" ? category : null,
                status: statusFilter !== "All" ? statusFilter : null,
                search: searchTerm || null
            };

            try {
                document.getElementById('filter-loader').classList.remove('hidden');

                const response = await fetch(`${API_BASE_URL}/filter-products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.data.filteredProducts) {
                    updateReorderTable(result.data.filteredProducts);
                    
                    if (result.data.filteredKpis) {
                        updateKPICards(result.data.filteredKpis);
                    }
                    
                    showNotification(`Filtered to ${result.data.filteredCount} products`, 'success');
                } else {
                    showNotification(result.error || 'Filtering failed', 'error');
                }

            } catch (error) {
                console.error('Filtering error:', error);
                showNotification('Failed to apply filters', 'error');
            } finally {
                document.getElementById('filter-loader').classList.add('hidden');
            }
        }

        // Chat Functions
        function setChatMessage(message) {
            document.getElementById('chat-input').value = message;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            const typingId = addTypingIndicator();

            try {
                const inventoryContext = {
                    ...appState.currentKPIs,
                    reorderData: appState.currentReorderData,
                    sessionId: appState.currentSession
                };

                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        inventory_context: inventoryContext,
                        sessionId: appState.currentSession
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                removeTypingIndicator(typingId);

                const botMessage = result.success ? result.response : "Sorry, I encountered an error. Please try again.";
                addChatMessage('bot', botMessage);

            } catch (error) {
                removeTypingIndicator(typingId);
                console.error('Chat error:', error);
                addChatMessage('bot', 'I\'m having connection issues. Please check your network and try again.');
            }
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const timestamp = new Date().toLocaleTimeString();
            const isUser = sender === 'user';

            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl shadow-lg ${
                    isUser
                        ? 'bg-gradient-to-r from-green-600 to-green-700 text-white'
                        : 'bg-white border border-gray-200 text-gray-800'
                }">
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 ${isUser ? 'bg-white bg-opacity-20' : 'bg-green-600'} rounded-full flex items-center justify-center">
                            <i class="fas ${isUser ? 'fa-user' : 'fa-robot'} text-sm ${isUser ? 'text-green-700' : 'text-white'}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm ${isUser ? 'text-white' : 'text-gray-800'}" style="white-space: pre-line;">${message}</div>
                            <p class="text-xs ${isUser ? 'opacity-70' : 'opacity-60'} mt-2">${timestamp}</p>
                        </div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const typingId = 'typing-' + Date.now();
            const chatMessages = document.getElementById('chat-messages');

            const typingDiv = document.createElement('div');
            typingDiv.id = typingId;
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `
                <div class="bg-white border border-gray-200 px-4 py-3 rounded-2xl shadow-lg">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="typing-dots flex space-x-1">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }

        // Action Functions
        function showSlowMovers() {
            if (!appState.currentDataset?.movers?.slowMovers) {
                showNotification('No slow movers data available', 'error');
                return;
            }
            
            const slowMovers = appState.currentDataset.movers.slowMovers;
            updateReorderTable(slowMovers);
            showNotification(`Showing ${slowMovers.length} slow-moving products`, 'success');
        }

        function showFastMovers() {
            if (!appState.currentDataset?.movers?.fastMovers) {
                showNotification('No fast movers data available', 'error');
                return;
            }
            
            const fastMovers = appState.currentDataset.movers.fastMovers;
            updateReorderTable(fastMovers);
            showNotification(`Showing ${fastMovers.length} fast-moving products`, 'success');
        }

        async function exportReport(type = 'json') {
            if (!appState.currentSession) {
                showNotification('No data to export. Please upload a CSV file first.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/export-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        type: type,
                        sessionId: appState.currentSession
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (type === 'json' && result.data) {
                        downloadJSON(result.data, 'inventory-report.json');
                    }
                    showNotification(result.message || `${type.toUpperCase()} export completed`, 'success');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed', 'error');
            }
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function refreshDashboard() {
            if (!appState.currentDataset) return;
            showNotification('Dashboard refreshed', 'success');
            updateTimestamps();
        }

        function resetDashboard() {
            appState = {
                currentSession: null,
                currentDataset: null, 
                currentKPIs: { totalProducts: 0, criticalAlerts: 0, averageTurnover: 0, inventoryHealth: 0 },
                currentReorderData: [],
                isLoading: false,
                charts: {},
                filterOptions: {},
                lastUpdated: null
            };

            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('dashboard-main').classList.add('hidden');
            showUploadState('idle');

            updateKPICards(appState.currentKPIs);
            updateReorderTable([]);
            
            // Reset charts
            ['category', 'health', 'turnover'].forEach(chartType => {
                const chartImg = document.getElementById(chartType + '-chart');
                const placeholder = document.getElementById(chartType + '-chart-placeholder');
                if (chartImg) chartImg.classList.add('hidden');
                if (placeholder) placeholder.classList.remove('hidden');
            });

            document.getElementById('file-input').value = '';
            document.getElementById('search-input').value = '';
            
            showNotification('Dashboard reset - ready for new data', 'success');
        }

        // Utility Functions
        function updateTimestamps() {
            const now = new Date().toLocaleString();
            const relativeTime = appState.lastUpdated ? 
                `Updated ${Math.round((Date.now() - appState.lastUpdated) / 1000 / 60)} min ago` : 
                'System Ready';
                
            document.getElementById('last-updated').textContent = relativeTime;
            document.getElementById('report-generated').textContent = now;
        }

        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md text-white ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Additional Features
        function generateInsights() {
            setChatMessage('Generate comprehensive insights about my inventory performance, including key risks and opportunities for optimization.');
            switchTab('ai-assistant');
            setTimeout(sendChatMessage, 500);
        }

        function generateExecutiveSummary() {
            setChatMessage('Create an executive summary of my inventory performance with key metrics, critical issues, and strategic recommendations.');
            switchTab('ai-assistant');
            setTimeout(sendChatMessage, 500);
        }

        function printDashboard() {
            window.print();
        }

        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showNotification('An unexpected error occurred. Please refresh and try again.', 'error');
        });
    </script>

    <style>
        .tab-button {
            @apply flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 text-gray-300 hover:text-white hover:bg-gray-700;
        }
        
        .tab-button.active {
            @apply bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg;
        }
        
        .btn-primary {
            @apply bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg flex items-center;
        }
        
        .btn-secondary {
            @apply bg-gray-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-all duration-200 flex items-center;
        }
        
        .filter-btn {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center;
        }
        
        .filter-btn.active {
            @apply bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg;
        }
        
        .action-btn {
            @apply bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg flex items-center;
        }
        
        .chat-suggestion {
            @apply block w-full text-left text-xs bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors duration-150;
        }
        
        .quick-chat-btn {
            @apply px-3 py-1 text-xs bg-gray-100 hover:bg-green-100 hover:text-green-700 rounded-full transition-all duration-200;
        }
        
        .chat-send-btn {
            @apply bg-gradient-to-r from-green-600 to-green-700 text-white p-3 rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg;
        }
        
        .export-btn {
            @apply w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-xl font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg flex items-center justify-center space-x-2;
        }
    </style>
</body>
</html>
